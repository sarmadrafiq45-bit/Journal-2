<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journal PWA (IndexedDB - High Capacity)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Custom styles for PWA feel */
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Style for clickable boxes (buttons) - unselected state */
        .selection-box {
            background-color: #f9fafb; /* Lightest gray background */
            color: #4b5563; /* Dark gray text */
            border: 2px solid #e5e7eb; /* Light border */
            text-align: center;
        }
        /* Style for clickable boxes (buttons) - selected state (Indigo) */
        .selection-box.selected {
            background-color: #e0e7ff; /* Indigo-100 */
            color: #4f46e5; /* Indigo-700 */
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .analysis-group {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        /* --- PDF EXPORT STYLES (CRITICAL) --- */
        #print-details-container {
            display: none; /* Hidden by default */
            page-break-after: always;
        }

        @media print {
            .no-print { display: none !important; }
            #print-details-container { 
                display: block !important; /* ONLY visible during print */
                margin: 0; 
                padding: 0;
            }
            body { 
                padding: 0; 
                margin: 0;
                background: white; 
            }
            .card { box-shadow: none; border: none; }
            
            /* Ensure details look good */
            .print-trade-card {
                border: 1px solid #ccc;
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 8px;
                page-break-inside: avoid;
            }
            .print-analysis-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-top: 10px;
            }
            .print-analysis-item {
                border-bottom: 1px dashed #eee;
                padding-bottom: 5px;
            }
        }
    </style>
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyIsInNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMTY1ZGEwLzAwMDAwMD90ZXh0PVQiLCJwdXJwb3NlcyI6ImFueSBtYXNrYWJsZSJ9XSwic2hvcnRfbmFtZSI6IlRyYWRlIEpvdXJuYWwiLCJuYW1lIjoiUGVyc29uYWwgVHJhZGUgSm91cm5hbCBQV0EiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInN0YXJ0X3VybCI6Ii4iLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzE2NWRhMCJ9">
</head>
<body class="bg-gray-50 min-h-screen pb-20">

    <!-- Loading Overlay for Asynchronous IndexedDB -->
    <div id="loading-overlay">
        <svg class="animate-spin h-10 w-10 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-lg font-medium text-gray-700">Loading Journal Data (IndexedDB)...</p>
        <p class="text-sm text-gray-500 mt-1">First load may take a moment. Please wait.</p>
    </div>

    <header class="p-4 bg-indigo-600 text-white shadow-lg no-print">
        <h1 class="text-2xl font-bold tracking-tight">Trade Journal (High Capacity)</h1>
        <p id="user-info" class="text-sm opacity-80 mt-1">Data is stored securely on this device's **IndexedDB** (High Capacity).</p>
    </header>

    <main class="container mx-auto p-4">
        
        <!-- --- PRINT-ONLY JOURNAL DETAILS CONTAINER --- -->
        <!-- This container is hidden during normal use but is populated and displayed during export -->
        <div id="print-details-container">
            <div class="p-6">
                <h1 class="text-2xl font-bold mb-4 border-b pb-2">Trade Journal Detailed Export</h1>
                <p class="mb-6 text-gray-600">Export Date: <span id="export-date"></span></p>
                <div id="print-summary-stats" class="grid grid-cols-4 gap-4 mb-8 text-center border p-3 rounded-lg bg-gray-50">
                    <!-- Summary stats for print will be populated here -->
                </div>
                <h2 class="text-xl font-bold mb-4">Detailed Trade Records</h2>
                <div id="printable-records">
                    <!-- Detailed trade cards are generated here -->
                </div>
            </div>
        </div>
        <!-- -------------------------------------------- -->


        <!-- Log New Trade Section -->
        <section class="mb-8 card bg-white p-5 rounded-xl no-print">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Log New Trade</h2>
            <form id="trade-form">

                <!-- --- SECTION: PRE-TRADE ANALYSIS --- -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4">Multi-Timeframe Analysis</h3>

                    <!-- Check News -->
                    <div class="analysis-group">
                        <label class="block text-base font-semibold text-gray-700 mb-2">Check News</label>
                        <div class="grid grid-cols-2 gap-3" id="analysis-news-group">
                            <button type="button" data-value="Yes" data-input="newsCheck" class="analysis-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                                Yes
                            </button>
                            <button type="button" data-value="No" data-input="newsCheck" class="analysis-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                                No
                            </button>
                        </div>
                        <input type="hidden" id="newsCheck" required>
                    </div>

                    <!-- Timeframe Analysis Groups -->
                    <div id="timeframe-analysis-container">
                        <!-- Content populated by JavaScript below -->
                    </div>

                    <!-- Hidden inputs for timeframes -->
                    <input type="hidden" id="weeklyChart" required>
                    <input type="hidden" id="dailyChart" required>
                    <input type="hidden" id="fourHourlyChart" required>
                    <input type="hidden" id="oneHourlyChart" required>
                    <input type="hidden" id="fifteenMinChart" required>
                    <input type="hidden" id="fiveMinChart" required>
                </div>


                <!-- --- SECTION: TRADE EXECUTION --- -->
                <div class="mb-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4">Transaction Details & Planning</h3>
                    
                    <!-- 1. TRADE ACTION (Clickable Boxes) -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trade Action (BUY / SELL)</label>
                    <div class="grid grid-cols-2 gap-3 mb-4" id="trade-type-group">
                        <button type="button" data-value="BUY" class="trade-type-btn selection-box p-4 rounded-lg text-lg font-bold transition duration-150">
                            BUY
                        </button>
                        <button type="button" data-value="SELL" class="trade-type-btn selection-box p-4 rounded-lg text-lg font-bold transition duration-150">
                            SELL (Short)
                        </button>
                    </div>
                    <input type="hidden" id="trade-type" required>

                    <!-- Setup Category -->
                    <div class="mb-4">
                        <label for="setupCategory" class="block text-sm font-medium text-gray-700 mb-2">Setup Category/Strategy</label>
                        <div class="grid grid-cols-3 gap-3" id="setup-category-group">
                            <button type="button" data-value="Breakout" data-input="setupCategory" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">Breakout</button>
                            <button type="button" data-value="Retest" data-input="setupCategory" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">Retest</button>
                            <button type="button" data-value="Reversal" data-input="setupCategory" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">Reversal</button>
                        </div>
                        <input type="hidden" id="setupCategory" required>
                    </div>

                    <!-- 2. BASIC INPUTS (Asset, Volume) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="asset" class="block text-sm font-medium text-gray-700">Asset/Symbol</label>
                            <input type="text" id="asset" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="volume" class="block text-sm font-medium text-gray-700">Volume/Shares</label>
                            <input type="number" id="volume" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- 3. PRICE INPUTS (Entry, Exit) -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label for="entry-price" class="block text-sm font-medium text-gray-700">Entry Price ($)</label>
                            <input type="number" step="0.01" id="entry-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="exit-price" class="block text-sm font-medium text-gray-700">Exit Price ($) (Optional)</label>
                            <input type="number" step="0.01" id="exit-price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <!-- R:R Ratio -->
                        <div class="mb-4">
                            <label for="riskReward" class="block text-sm font-medium text-gray-700">Planned R:R (e.g., 2.5)</label>
                            <input type="number" step="0.1" id="riskReward" required min="0.1" placeholder="e.g., 2.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- --- SECTION: TRADE OUTCOME & REFLECTION --- -->
                <div class="mb-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4">Outcome & Reflection</h3>

                    <!-- 4. TRADE RESULT (Clickable Boxes) -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">P&L Result (Optional)</label>
                    <div class="grid grid-cols-3 gap-3 mb-6" id="trade-result-group">
                        <button type="button" data-value="WIN" class="trade-result-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                            <span class="text-xl">üöÄ</span> WIN
                        </button>
                        <button type="button" data-value="LOSS" class="trade-result-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                            <span class="text-xl">üîª</span> LOSS
                        </button>
                        <button type="button" data-value="BE" class="trade-result-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                            <span class="text-xl">‚è∏Ô∏è</span> B/E
                        </button>
                    </div>
                    <input type="hidden" id="trade-result">

                    <label for="notes" class="block text-sm font-medium text-gray-700">Notes & Lessons Learned</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <button type="submit" id="log-trade-btn" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Save Trade Log (IndexedDB)
                </button>
            </form>
        </section>

        <!-- Summary & Action Buttons Section -->
        <section class="mb-8 card bg-white p-5 rounded-xl no-print">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Journal Summary</h2>

            <!-- Filter by Asset -->
            <div class="mb-4">
                <label for="filter-asset" class="block text-sm font-medium text-gray-700">Filter by Asset</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="filter-asset" placeholder="e.g., EURUSD, TSLA" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="clear-filter-btn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div id="summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5 text-center">
                <!-- Stats will be populated here -->
            </div>

            <button onclick="exportToPdf()" class="w-full md:w-auto py-2 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 flex items-center justify-center mx-auto">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m4 0v3m4-3v3m-3 0h2"></path></svg>
                Export COMPLETE Journal to PDF
            </button>
        </section>
        
        <!-- Trade Records Section (Summary Table) -->
        <section id="trade-list-section" class="card bg-white p-5 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 no-print">Trade Records (Summary)</h2>
            
            <div id="trades-list" class="overflow-x-auto no-print">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">R:R</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P/L ($)</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trade-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="7" class="p-4 text-center text-gray-500">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Detail Modal (Hidden by Default) -->
            <div id="detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 hidden items-center justify-center p-4 no-print" onclick="hideModal(event)">
                <div class="bg-white rounded-xl max-w-lg w-full p-6 card" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-indigo-600">Trade Details</h3>
                    <div id="modal-content" class="space-y-3 text-gray-700 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Details will be injected here -->
                    </div>
                    <button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="mt-6 w-full py-2 px-4 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700">Close</button>
                </div>
            </div>

            <!-- Custom Alert/Modal (for status messages) -->
            <div id="custom-alert" class="fixed bottom-4 right-4 z-50 p-4 rounded-lg text-white shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none"></div>

        </section>

    </main>

    <script type="module">
        let tradesData = []; // Cache for current trades
        const DB_NAME = 'TradeJournalDB';
        const STORE_NAME = 'trades';
  